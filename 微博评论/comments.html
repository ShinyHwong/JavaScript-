<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>评论</title>
    <link href="style/weibo.css" rel="stylesheet"/>
    <script src="js/jquery-3.2.1.js"></script>
</head>
<body>
<div id="mainbody">
    <!--发布微博-->
    <div class="takeComment">
        <textarea name="textarea" class="takeTextField" id="submitText"></textarea>
        <div class="takeSbmComment">
            <input id="btn_send" type="button" class="inputs" value=""/>
            <span>(可按 Enter 回复)</span>
        </div>
    </div>
    <!--微博列表-->
    <div class="commentOn">
        <div class="noContent">暂无留言</div>
        <div id="messList" class="messList">
            <!--<div class="reply">
                <p class="replyContent">卫士，新款卫士将推出总共14种车身式样。其中， XS旅行款车型售价为32295英镑(约33.6万元)。</p>
                <p class="operation">
                    <span class="replyTime">2016-09-08 16:37:60</span>
                    <span class="handle">
                        <a href="javascript:;" class="top">0</a>
                        <a href="javascript:;" class="down_icon">0</a>
                        <a href="javascript:;" class="cut">删除</a>
                    </span>
                </p>
            </div>-->
        </div>
        <div id="page" class="page">
            <!--
        	<a href="javascript:;" class="active">1</a>
        	<a href="javascript:;">2</a>
        	<a href="javascript:;">3</a>
            -->
        </div>
    </div>
</div>

<script>
    $(function () {
        //获取DOM标签
        var input = $('#submitText');
        var send = $('#btn_send');
        var container = $('#messList');
        var tip = $('.noContent');

        //获取首页内容
        getPageContent(1);
        getPageCount();

        //点击按钮评论
        send.click(function () {
            submit();
        });
        //输入回车评论
        document.body.onkeydown = function (event) {
            var event = event || window.event;
            if (event.keyCode === 13) {
                submit();
                return false; //阻止换行
            }
        };
        //添加评论
        function submit() {
            //跳转到第一页
            getPageContent(1);
            //切换class
            $('#page').children().first().addClass('active').siblings().removeClass('active');

            //获取输入内容
            var text = input.val();
            //输入内容为空时进行提示
            if (text.trim() === '') {
                alert('请输入内容！');
                return;
            }
            //发送ajax请求
            $.ajax({
                type: 'GET',
                url: 'weibo.php?act=add&content=' + text,
                success: function (request) {
                    //清空输入框中的内容
                    input.val('');

                    //将返回的json转换成对象
                    var res = eval('(' + request + ')');
                    //自定义属性添加传入的内容
                    res.content = text;
                    container.prepend(creatTag(res));
                    //获取页数并创建标签及相关点击切换事件
                    getPageCount();
                    //清除暂无留言
                    tip.hide();
                    //若内容超过5条则把最后一条移除再添加
                    if (container.children().length > 4) {
                        container.children().last().remove();
                    }
                }
            });
        }

        //时间戳转换成时间
        function timeExchange(time) {
            var date = new Date(time * 1000);
            //对时间进行保持两位数优化处理
            var second = date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds();
            var minutes = date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes();
            var hour = date.getHours() < 10 ? '0' + date.getHours() : date.getHours();
            //返回拼接过后的时间字符串 eg：2017-5-2 13:21:54
            return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ' ' + hour + ':' + minutes + ':' + second;
        }

        //动态创建标签
        function creatTag(obj) {
            //获取发表评论时间并进行转换
            obj.time = timeExchange(obj.time);
            //inner为字符串形式
            var inner = '<p class="replyContent">' + obj.content + '</p>' +
                '<p class="operation">' +
                '<span class="replyTime">' + obj.time + '</span>' +
                '<span class="handle">' +
                '<a href="javascript:;" class="top">' + (obj.acc = obj.acc || 0) + '</a>' +
                '<a href="javascript:;" class="down_icon">' + (obj.ref = obj.ref || 0) + '</a>' +
                '<a href="javascript:;" class="cut">删除</a>' +
                '</span>' +
                '</p>';
            var div = document.createElement('div');
            //创建div把字符串变成标签来获取到
            div.innerHTML = inner;
            $(div).addClass('reply');
            //找到指定的单个标签
            up($(div).find('.top'), obj['id']);
            down($(div).find('.down_icon'), obj['id']);
            deleteContent($(div).find('.cut'), obj['id']);
            return div;
        }

        //赞的更新
        function up(elem, id) {
            //点击赞时
            elem.click(function () {
                $.ajax({
                    type: 'GET',
                    url: 'weibo.php?act=acc&id=' + id,
                    success: function () {
                        elem.text(+elem.text() + 1);
                    }
                })
            })
        }

        //踩的更新
        function down(elem, id) {
            //点击赞时
            elem.click(function () {
                $.ajax({
                    type: 'GET',
                    url: 'weibo.php?act=ref&id=' + id,
                    success: function () {
                        elem.text(+elem.text() + 1);
                    }
                })
            })
        }

        //删除内容
        function deleteContent(elem, id) {
            elem.click(function () {
                $.ajax({
                    type: 'GET',
                    url: 'weibo.php?act=del&id=' + id,
                    success: function () {
                        //刷新当前页数界面
                        getPageContent(+$('.active').text());
                        getPageCount();
                    }
                })
            })

        }

        //获取页数
        function getPageCount() {
            $.ajax({
                type: 'GET',
                url: 'weibo.php?act=get_page_count',
                success: function (res) {
                    //清空原有的页数标签
                    $('#page').children().remove();
                    //将返回的json转换成对象并获取页数数据
                    var count = eval('(' + res + ')').count;
                    //动态创建页数标签
                    for (var i = 1; i <= count; i++) {
                        var aTag = $('<a href="javascript:;"></a>');
                        aTag.text(i);
                        $('#page').append(aTag);
                    }
                    //默认第一个为active
                    $('#page').children().first().addClass('active');
                    //点击切换active
                    $('#page').children().on('click', function () {
                        $(this).addClass('active').siblings().removeClass('active');
                        //添加页面内容
                        getPageContent($(this).text());
                    })
                }
            })
        }

        //刷新每页内容
        function getPageContent(num) {
            $.ajax({
                type: 'GET',
                url: 'weibo.php?act=get&page=' + num,
                success: function (res) {
                    //清空页面内容
                    container.html('');
                    //将json转换成对象
                    var pageContent = eval('(' + res + ')');
                    //没有内容时才显示暂无内容
                    pageContent[0] ? tip.hide() : tip.show();
                    //动态添加每页的内容
                    for (var i = 0; i < 5; i++) {
                        //当最后一页标签不足5个时，加载完成就跳出循环
                        if (!pageContent[i]) break;
                        container.append(creatTag(pageContent[i]));
                    }
                }
            })
        }

    })
</script>

</body>
</html>